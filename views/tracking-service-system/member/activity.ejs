<%var collapse="";%> <%var maxLength = 0;%>
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <!--Metatags-->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatble" content="ie=edge" />
    <!--Website Title-->
    <title>Activity</title>
    <!--Calling Favicon-->
    <link rel="icon" href="../images/tracking/favicon.png" />
    <link rel="shortcut icon" href="../images/tracking/favicon.ico" />
    <!--FontAwesome CDN-->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"
    />
    <!--Normalize v8.0.1 CSS FILE-->
    <link rel="stylesheet" href="../css/normalize.css" />
    <!--Bootstrap v4.6.0 CSS FILE-->
    <link rel="stylesheet" href="../css/bootstrap.min.css" />
    <!--Fonts Are Loads From Here-->
    <link rel="stylesheet" href="../fonts/fonts.css" />
    <!--Gabazzo Common CSS File-->
    <link rel="stylesheet" href="../css/gabazzo.common.css" />
    <!--Lightcase CSS File-->
    <link rel="stylesheet" href="../css/lightcase.css" />
    <!--Main Stylesheet-->
    <link rel="stylesheet" href="../css/updatedStyles.css" />
    <!--Stylesheet For The Responsiveness-->
    <link rel="stylesheet" href="../css/responsive.css" />
    <!--Stylesheet For The Night Mode-->
    <link rel="stylesheet" href="../css/night.mode.css" />
  </head>

  <body>
    
    <!--===== Markup For "Header" Starts From Here =====-->
<header class="header">
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <div class="logo_mode_switching">
        <ul>
          <li>
            <a href="/" class="navbar-brand"
              ><img
                src="../images/layout/gabazzo_logo_white.png"
                class="img-fluid"
                alt=""
            /></a>
          </li>
          <li>
            <a class="mode_icon" href="javascript:void(0)">
              <img
                src="../images/layout/mode_icon_night.png"
                class="img-fluid night_icon"
                title="Night Mode"
                data-toggle="tooltip"
                alt=""
              />
              <img src="../images/layout/mode_icon_day.png" class="img-fluid day_icon" title="Day Mode" data-toggle="tooltip" alt=""/>
            </a>
          </li>
        </ul>
      </div>

      <div class="members_navbar">
        <div class="mobile_search_btn_menubar">
          <div class="cp_search_btn dropdown">
            <a
              href="javascript:void(0)"
              data-target="#companySearchBar"
              data-toggle="dropdown"
              class="nav-link"
              ><img
                src="../images/layout/search_icon_white.png"
                class="img-fluid"
                alt=""
            /></a>

            <div
              class="dropdown-menu company_search_down"
              aria-labelledby="companySearchBar"
            >
              <form action="">
                <div class="company_search_field">
                  <input
                    id="myInput"
                    type="search"
                    placeholder="Search..."
                    class="form-control"
                  />
                  <button class="btn" type="submit">
                    <img
                      src="../images/layout/search_icon_black.png"
                      class="black_icon"
                      alt=""
                    />
                    <img
                      src="../images/layout/search_icon_white.png"
                      class="white_icon"
                      alt=""
                    />
                  </button>
                </div>
              </form>
            </div>
          </div>

          <button
            class="navbar-toggler"
            data-target="#responsive-bar"
            data-toggle="collapse"
          >
            <div class="humbergur_icon">
              <span></span><span></span><span></span><span></span>
            </div>
          </button>

          <% if(currentUser) { %>
          <a
            href="javascript:void(0)"
            class="nav-link profile_pic_link membersProfilePic"
          >
            <div class="profile_pic">
              <% if (currentUser?.isCompany) { %> <% if(currentUser.logo) {
              %>
              <img src="<%= currentUser.logo %>" class="img-fluid" alt="" />
              <% } else {%>
              <img src="../images/man.png" class="img-fluid" alt="" />
              <% }%> <% } else { %> <% if(currentUser?.profilePicture) {%>
              <img
                src="<%= currentUser.profilePicture %>"
                class="img-fluid"
                alt="<%= currentUser.username %>"
              />
              <%} else {%>
              <img
                src="../images/man.png"
                class="img-fluid"
                alt="<%= currentUser.username %>"
              />
              <% }%> <% } %>
              <span class="activity_status online_status"></span>
            </div>
          </a>
          <% } %>
        </div>
      </div>
      <div class="collapse navbar-collapse" id="responsive-bar">
        <div class="menus ml-auto">
          <ul class="navbar-nav services_menu">
            <li class="nav-item dropdown">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                data-toggle="dropdown"
                >Construction Services</a
              >
              <div class="dropdown-menu">
                <ul class="dropdown_column">
                  <li>
                    <a
                      href="/search?category=roofing services"
                      class="dropdown-item"
                      >Roofing</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=landscaping services"
                      class="dropdown-item"
                      >Landscaping</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=junk removal"
                      class="dropdown-item"
                      >Junk Removal</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=masonry services"
                      class="dropdown-item"
                      >Masonry</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=plumbing services"
                      class="dropdown-item"
                      >Plumbing</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=hvac services"
                      class="dropdown-item"
                      >HVAC</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=pest control"
                      class="dropdown-item"
                      >Pest Control</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=painting services"
                      class="dropdown-item"
                      >Painting</a
                    >
                  </li>
                </ul>
                <ul class="dropdown_column">
                  <li>
                    <a
                      href="/search?category=flooring services"
                      class="dropdown-item"
                      >Flooring</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=electrical services"
                      class="dropdown-item"
                      >Electrical</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=moving services"
                      class="dropdown-item"
                      >Moving</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=appliance services"
                      class="dropdown-item"
                      >Appliance</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=locksmith services"
                      class="dropdown-item"
                      >Locksmith</a
                    >
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                data-toggle="dropdown"
                >Vehicle Services</a
              >
              <div class="dropdown-menu">
                <ul class="dropdown_column">
                  <li>
                    <a
                      href="/search?category=towing services"
                      class="dropdown-item"
                      >Towing</a
                    >
                  </li>
                  <li>
                    <a
                      href="/search?category=vehicle repair"
                      class="dropdown-item"
                      >Vehicle Repair</a
                    >
                  </li>
                </ul>
              </div>
            </li>
          </ul>
          <ul class="navbar-nav access_menu">
            <li
              class="nav-item cp_search_btn cp_search_btn_desktop dropdown"
            >
              <a
                href="javascript:void(0)"
                data-target="#companySearchBar"
                data-toggle="dropdown"
                class="nav-link"
                ><img
                  src="../images/layout/search_icon_white.png"
                  class="img-fluid"
                  alt=""
              /></a>
              <div
                class="dropdown-menu company_search_down"
                aria-labelledby="companySearchBar"
              >
                <form action="">
                  <div class="company_search_field">
                    <input
                      id="myInput"
                      type="search"
                      placeholder="Search..."
                      class="form-control"
                    />
                    <button class="btn" type="submit">
                      <img
                        src="../images/layout/search_icon_black.png"
                        class="black_icon"
                        alt=""
                      />
                      <img
                        src="../images/layout/search_icon_white.png"
                        class="white_icon"
                        alt=""
                      />
                    </button>
                  </div>
                </form>
              </div>
            </li>
            <% if(currentUser) { %>
            <li class="nav-item desktop_only_link">
              <a
                href="/inbox/<%= lastMessage?.messages?.receiver.id %>"
                class="nav-link"
                >Messages</a
              >
            </li>
            <% if(currentUser && !currentUser.isCompany) { %>
            <li class="nav-item desktop_only_link">
              <a href="/saved-list" class="nav-link">Saved List</a>
            </li>
            <% } %>
            <li class="nav-item profile_pic_desktop">
              <a
                href="javascript:void(0)"
                class="nav-link profile_pic_link membersProfilePic"
              >
                <div class="profile_pic">
                  <% if (currentUser?.isCompany) { %> <%
                  if(currentUser.logo) { %>
                  <img
                    src="<%= currentUser.logo %>"
                    class="img-fluid"
                    alt=""
                  />
                  <% } else {%>
                  <img src="../images/man.png" class="img-fluid" alt="" />
                  <% }%> <% } else { %> <% if(currentUser.profilePicture)
                  {%>
                  <img
                    src="<%= currentUser.profilePicture %>"
                    class="img-fluid"
                    alt="<%= currentUser.username %>"
                  />
                  <%} else {%>
                  <img
                    src="../images/man.png"
                    class="img-fluid"
                    alt="<%= currentUser.username %>"
                  />
                  <% }%> <% } %>
                  <span class="activity_status online_status"></span>
                </div>
              </a>
            </li>
            <% } else {%>
            <li class="nav-item">
              <a href="/login" class="nav-link sign_in">Sign In</a>
            </li>
            <li class="nav-item">
              <a href="/sign-up" class="nav-link gbtn gbtn_white_bdr"
                >Sign Up</a
              >
            </li>
            <li class="nav-item">
              <a href="/become-a-seller-overview" class="nav-link gbtn"
                >Become a Seller</a
              >
            </li>
            <% } %>
          </ul>
        </div>
      </div>
    </div>
  </nav>
</header>
<!--===== Markup For "Header" Ends Here =====-->
<% if(currentUser) { %>
<!--===== Markup For "Members Profile Link" Starts From Here =====-->
<div class="membersProfileLinks">
  <div class="dismissMembersProfileLinks">
    <i class="fa fa-times"></i>
  </div>
  <div class="members_profile_pic">
    <% if (currentUser?.isCompany) { %> <% if(currentUser.logo) { %>
    <a href="javascript:void(0)"
      ><img
        src="<%= currentUser.logo %>"
        class="img-fluid"
        alt="<%= currentUser.username %>"
    /></a>
    <% } else {%>
    <a href="javascript:void(0)"
      ><img src="../images/man.png" class="img-fluid" alt="profile Picture"
    /></a>
    <% }%>
    <h6><%= currentUser.companyName %></h6>
    <% } else { %> <% if(currentUser?.profilePicture) {%>
    <a href="javascript:void(0)"
      ><img
        src="<%= currentUser.profilePicture %>"
        class="img-fluid"
        alt="<%= currentUser.username %>"
    /></a>
    <%} else {%>
    <a href="javascript:void(0)"
      ><img src="../images/man.png" class="img-fluid" alt="profile picture"
    /></a>
    <% }%>
    <h6><%= currentUser.firstName + " " + currentUser.lastName %></h6>
    <% } %>
  </div>
  <div class="profile_links">
    <% if (currentUser.isCompany) { %>
    <ul>
      <li>
        <i class="fas fa-user"></i>
        <a href="/company-dashboard">View Dashboard</a>
      </li>
      <li class="mobile_only">
        <i class="fas fa-envelope"></i>
        <a href="/inbox/<%= lastMessage?.messages?.receiver.id %>">Messages</a></li>
      <li><i class="fas fa-shopping-cart"></i><a href="/manage-orders">Manage Orders</a></li>
      <li><i class="fas fa-cog"></i><a href="/company-settings/account">Settings</a></li>
      <li><i class="fas fa-power-off"></i> <a href="/logout">Logout</a></li>
    </ul>
    <% } else { %>
    <ul>
      <li><i class="fas fa-user"></i><a href="/member-profile/<%= currentUser._id %>">View Profile</a></li>
      <li class="mobile_only">
        <i class="fas fa-envelope"></i>
        <a href="/inbox/<%= lastMessage?.messages?.receiver.id %>"
          >Messages</a
        >
      </li>
      <% if(currentUser && !currentUser.isCompany) { %>
      <li class="mobile_only"><i class="fas fa-list-alt"></i> <a href="/saved-list">Saved List</a></li>
      <% } %>
      <li><i class="fas fa-shopping-cart"></i><a href="/manage-orders">Manage Orders</a></li>
      <li><i class="fas fa-cog"></i><a href="/company-settings/account">Settings</a></li>
      <li><i class="fas fa-power-off"></i> <a href="/logout">Logout</a></li>
    </ul>
    <% } %>
  </div>
</div>
<!--===== Markup For "Members Profile Link" Ends Here =====-->
<% } %>

    <!--===== Markup For "Navbar" Starts From Here =====-->
    <nav class="ts_navbar">
      <div class="container">
        <div class="nav_with_bar">
          <div class="menu">
            <a class="mobile_ts_menu_switch" href="javascript:void(0)"
              ><img
                src="../images/tracking/menubar_icon.png"
                class="img-fluid"
                alt=""
            /></a>
            <ul>
              <a class="dismiss_mobile_ts_menu" href="javascript:void(0)"
                ><i class="fa fa-times"></i
              ></a>
              <li class="active"><a href="javascript:void(0)">Activity</a></li>
              <li><a href="/tracking/<%=job?._id%>">Tracking Info</a></li>
              <script>
                var jobId = "<%= job?._id %>";
                var progress = "<%=activity?.progress%>";
                var status = "<%=job?.status%>";
              </script>
              <li><a href="/requirements/<%=job?._id%>">Requirements</a></li>
              <li><a href="/pdffiles/<%=job?._id%>">PDF Files</a></li>
            </ul>
          </div>

          <div class="ellipsis_menu">
            <div class="dropdown">
              <a
                class="three_dots"
                href="#"
                role="button"
                id="ellipsisMenu"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <span></span>
                <span></span>
                <span></span>
              </a>

              <div class="dropdown-menu" aria-labelledby="ellipsisMenu">
                <ul>
                  <li><a href="javascript:void(0)">Resolve an Issue</a></li>
                  <li>
                    <a href="/company-profile/<%=job?.seller?._id%>"
                      >View Company Profile</a>
                  </li>
                  <li><a href="javascript:void(0)">Cancel Order</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <!--===== Markup For "Navbar" Ends Here =====-->

    <section class="ts_middle_wrap">
      <div class="container">
        <div class="ts_middle">
          <!--===== Markup For "Services Info" Starts From Here =====-->
          <div class="service_info">
            <div class="title">
              <h3><%=job?.service?.title%></h3>
            </div>

            <div class="service_img_descrip">
              <div class="service_img">
                <img
                  src="<%=job?.service?.images[0]?.url%>"
                  class="img-fluid"
                  alt=""
                />
              </div>
              <div class="service_descrip">
                <p>
                  <%=job?.service?.description%>
                  <a href="javascript:void(0)">Show More</a>
                </p>
              </div>
            </div>

            <div class="order_facts">
              <div class="single_fact">
                <div class="fact_title">
                  <h5>Start Date:</h5>
                </div>
                <div class="tiny_box">
                  <h5>
                    <%if(job?.status === "Missing Details") {%> <%=
                    moment(job?.createdAt).format('LL'); %> <%} else {%> <%=
                    moment(job?.starting_time).format('LL'); %> <%}%>
                  </h5>
                  <i class="far fa-calendar-alt"></i>
                </div>
              </div>

              <div class="single_fact">
                <div class="fact_title">
                  <h5>Due On:</h5>
                </div>
                <div class="tiny_box">
                  <h5><%= moment(job?.finaldeliverydate).format('LL'); %></h5>
                  <i class="far fa-calendar-alt"></i>
                </div>
              </div>

              <div class="single_fact">
                <div class="fact_title">
                  <h5>Total Paid:</h5>
                </div>
                <div class="tiny_box">
                  <h5><%=job?.offer?.totalCost%></h5>
                  <i class="fas fa-dollar-sign"></i>
                </div>
              </div>

              <div class="single_fact">
                <div class="fact_title">
                  <h5>Revisions:</h5>
                </div>
                <div class="tiny_box">
                  <h5><%=job?.offer?.revision%></h5>
                  <i class="fas fa-sync-alt"></i>
                </div>
              </div>

              <div class="single_fact">
                <div class="fact_title">
                  <h5>Status:</h5>
                </div>
                <div class="tiny_box">
                  <h5><span class="color"><%=job?.status%></span></h5>
                  <i class="far fa-check-circle"></i>
                </div>
              </div>
            </div>
          </div>
          <!--===== Markup For "Services Info" Ends Here =====-->

          <div class="order_requirements">
            <!--===== Markup For "Order Requirements & Activity" Starts From Here =====-->
            <div class="submit_info">
              <div class="title_banner">
                <h3>
                  <i class="far fa-calendar-alt"></i> Order Started:
                  <%if(job?.status === "Missing Details") {%> <%=
                  moment(job?.createdAt).format('Do MMMM, YYYY'); %> <%} else
                  {%> <%= moment(job?.starting_time).format('Do MMMM, YYYY'); %>
                  <%}%>
                </h3>
              </div>

              <div class="activity_accordion" id="theActivity">
                <div class="single_item">
                  <div class="click_item">
                    <a
                      class="collapsed"
                      href="javascript:void(0)"
                      data-target="#collapseOne"
                      data-toggle="collapse"
                    >
                      <div class="the_click">
                        <h4>
                          <i class="far fa-edit"></i> Order Requirements
                          Submitted By Client.
                        </h4>
                      </div>
                    </a>
                  </div>
                  <div
                    id="collapseOne"
                    class="collapse fade contents"
                    data-parent="#theActivity"
                  >
                    <div class="requirements_info">
                      <div class="requirements_texts">
                        <p><%=job?.description%></p>
                      </div>

                      <%if(job?.job_images && job?.job_images.length>0) {%>
                      <div class="requirements_image">
                        <%job?.job_images?.map(image=>{%>
                        <div class="single_image">
                          <a
                            href="<%=image?.url%>"
                            class="requirementsGallery"
                            data-rel="requirementsGallery:theSlider"
                          >
                            <img
                              src="<%=image?.url%>"
                              class="img-fluid"
                              alt=""
                            />
                          </a>
                        </div>
                        <%})%>
                      </div>
                      <%}%>
                    </div>
                  </div>
                </div>
                <%if(activity?.tracking_info?.length > 0) {%>
                <%activity?.tracking_info?.map((track, index)=>{%>
                <div class="single_item">
                  <div class="click_item">
                    <a
                      class="collapsed"
                      href="javascript:void(0)"
                      data-target="#collapse<%=index%>"
                      data-toggle="collapse"
                    >
                      <div class="the_click">
                        <h5>Tracking Service #<%=index+1%> (Company Update)</h5>
                        <div class="tracking_progress">
                          <div
                            class="filled_bar"
                            style="width: <%=track?.progress%>%"
                          >
                            <span><%=track?.progress%>%</span>
                          </div>
                        </div>
                      </div>
                    </a>
                  </div>
                  <div
                    id="collapse<%=index%>"
                    class="collapse fade contents"
                    data-parent="#theActivity"
                  >
                    <div class="updated_info">
                      <div class="updated_texts">
                        <p><%=track?.description%></p>
                      </div>
                      <%if(track?.files?.length > 0) {%>
                      <div class="updated_image">
                        <%track?.files?.map((file, index)=>{%>
                        <div class="single_image">
                          <a
                            href="<%=file.url%>"
                            class="firstGallery"
                            data-rel="firstGallery:theSlider"
                          >
                            <img src="<%=file.url%>" class="img-fluid" alt="" />
                          </a>
                        </div>
                        <%})%>
                      </div>
                      <%}%>
                    </div>
                  </div>
                </div>
                <%})%> <%}%>
                <!--===== Markup For "Order Requirements & Activity" Starts From Here =====-->
                <script>
                  var messagesLength = "<%=job?.messages?.length%>";
                </script>
                <%if(job?.messages?.length > 0) {%>
                <div class="single_item">
                  <div class="click_item">
                    <a
                      class="collapsed"
                      href="javascript:void(0)"
                      data-target="#collapse"
                      data-toggle="collapse"
                    >
                      <div class="the_click">
                        <h5>
                          Chat between You and <%=job?.seller?.companyName%>
                        </h5>
                      </div>
                    </a>
                  </div>
                  <div
                    id="collapse"
                    class="collapse fade contents"
                    data-parent="#theActivity"
                  >
                    <div class="updated_info">
                      <%job?.messages?.map((message, index)=>{%>
                      <div class="updated_texts message<%=index%>">
                        <div class="msg_wrap">
                          <span class="profile_link_image">
                            <%if((job?.buyer?._id).toString() ===
                            (message.user).toString()){%>
                    
                                  <% if(job?.buyer?.profilePicture){ %>
                                    <a href="javascript:void(0)"
                                    ><img
                                      src="<%=job?.buyer?.profilePicture%>"
                                      alt="<%=job?.buyer?.firstName + ' ' +
                                    job?.buyer?.lastName%>"
                                      class="img-fluid"
                                      style="max-width: 10%"
                                  /></a>
                                  <% } else { %>
                                    <a href="javascript:void(0)"
                                    >
                                    <img
                                    src="../images/man.png"
                                    class="img-fluid"
                                    alt="<%=job?.seller?.companyName %>"
                                    style="max-width: 10%"
                                    /></a>
                                  <% } %> 

                            <%} else {%>
                            

                                  <% if(job?.seller?.logo){ %>
                                    <a href="javascript:void(0)"
                                    ><img
                                      src="<%=job?.seller?.logo%>"
                                      alt="<%=job?.seller?.companyName%>"
                                      class="img-fluid"
                                      style="max-width: 10%"
                                  /></a>
                                  <% } else { %>
                                    <a href="javascript:void(0)"
                                    >
                                    <img
                                    src="../images/man.png"
                                    class="img-fluid"
                                    alt="<%=job?.seller?.companyName %>"
                                    /></a>
                                  <% } %> 

                            <%}%>
                          </span>
                          <span class="msg_content">
                            <span class="msg_sender">
                              <%if((job?.buyer?._id).toString() ===
                              (message.user).toString()){%>
                              <%=job?.buyer?.firstName + ' ' +
                              job?.buyer?.lastName%> <%} else {%>
                              <%=job?.seller?.companyName%> <%}%>
                            </span>
                            |
                            <time
                              ><%= moment( message.createdAt ).format('LL');
                              %></time
                            >
                            <div class="msg_body">
                              <p><%=message.message%></p>
                            </div>
                          </span>
                        </div>
                      </div>
                      <%})%>
                      <div class="updated_image messages_images">
                        <%job?.messages?.map((message, index)=>{%>
                        <%if(message?.attachments?.length > 0) {%>
                        <%message?.attachments?.map((file, index)=>{%>
                        <div class="single_image">
                          <a
                            href="<%=file.url%>"
                            class="firstGallery"
                            data-rel="firstGallery:theSlider"
                          >
                            <img src="<%=file.url%>" class="img-fluid" alt="" />
                          </a>
                        </div>
                        <%})%> <%}%> <%})%>
                      </div>
                    </div>
                  </div>
                </div>
                <%}%>
                <!--===== Markup For "Messages" Ends Here =====-->
              </div>
            </div>
            <!--===== Markup For "Order Requirements & Activity" Ends Here =====-->
          </div>

          <!--===== Markup For "Activity Message Box" Starts From Here =====-->
          <div class="activity_msg_box">
            <div class="user_info">
              <div class="profile_pic">
                <a href="javascript:void(0)">

                <% if(job?.buyer?.logo){ %>
                  <img
                    src="<%=job?.buyer?.logo %>"
                    class="img-fluid"
                    alt="<%=job?.seller?.companyName%>"
                  />
                <% } else { %>
                  <img
                  src="../images/man.png"
                  class="img-fluid"
                  alt="<%=job?.seller?.companyName %>"
                  />
                <% } %> 

              </a>
                <span class="activity_status online_status"></span>
              </div>
              <div class="profile_name">
                <h5>
                  Need to Text Something with
                  <a href="/company-profile/<%= job?.seller?._id %>" ><%= job?.seller?.companyName %></a>
                </h5>
                <time>Local Time: <%=moment().format("HH:mm a");%></time>
              </div>
            </div>

            <div class="msg_input_box">
              <textarea
                name=""
                id="textarea"
                cols="30"
                rows="4"
                placeholder="Type Your Message Here..."
                class="form-control"
                maxlength="2500"
              ></textarea>

              <div class="char_counter">
                <h6 id="detailsMaxCounter"><%=maxLength%>/2500</h6>
              </div>
            </div>

            <div class="box_actions">
              <ul>
                <li id="upload_widget">
                  <label class="attachment gbtn" href="javascript:void(0)">
                    <img
                      src="../images/tracking/attachment_icon_white.png"
                      class="img-fluid"
                      alt=""
                    />
                    <span class="attach_texts">Attach Files</span>
                  </label>
                </li>
                <li>
                  <button
                    class="btn gbtn submit_btn"
                    id="sendMsgBtn"
                    type="submit"
                  >
                    Send
                  </button>
                </li>
              </ul>
            </div>
          </div>
          <!--===== Markup For "Activity Message Box" Ends Here =====-->

          <!--===== Markup For "View Inbox" Starts From Here =====-->
          <div class="view_inbox">
            <p>
              View Conversation with
              <a href="/inbox/<%= job?.seller?._id %>"
                ><%=job?.seller?.username%></a
              >
              in Your Inbox.
            </p>
          </div>
          <!--===== Markup For "View Inbox" Ends Here =====-->

          <!--===== Markup For "Delivered & Complete Order" Starts From Here =====-->
          <div class="delivered_complete_btns">
            <ul>
              <%if(activity?.progress===100){%>
              <li>
                <a href="javascript:void(0)" class="gbtn" name="completed"
                  >Complete Order</a
                >
              </li>
              <%}%>
              <li>
                <a
                  href="javascript:void(0)"
                  data-target="#extendDelivery"
                  data-toggle="modal"
                  class="gbtn"
                  >Extend Delivery</a
                >
              </li>
            </ul>
          </div>
          <!--===== Markup For "Delivered & Complete Order" Ends Here =====-->
        </div>
      </div>
    </section>

    <!--===== Markup For "Footer Copyright" Starts From Here =====-->
    <footer class="footer_wrap">
      <div class="copyright">
        <div class="container">
          <p>Copyright © 2021 Gabazzo. All Rights Reserved. Patent Pending</p>
        </div>
      </div>
    </footer>
    <!--===== Markup For "Footer Copyright" Ends Here =====-->

    <!--===== Markup For "Extend Delivery Modal" Starts From Here =====-->
    <div class="modal fade common_modal" id="extendDelivery">
      <div
        class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
      >
        <div class="modal-content">
          <div class="modal-header">
            <h3>Extend Dealine</h3>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <form action="">
              <div class="form-group extend_delivery">
                <label for=""
                  >Select the Number of Days You Wish to Extend Deadline:</label
                >
                <div class="input_icon">
                  <select name="" id="extendDeliveryDays" class="form-control">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                  <i class="far fa-clock"></i>
                </div>
              </div>
            </form>

            <div class="note_texts">
              <p>
                <b>Note:</b> The deadline must be approved by the client, if the
                work is finished after the deadline you can still submit as
                "Complete Order" then the client make it's final decision on
                accepting the order or may request for revisions as they may
                subjected to extra cost.
              </p>
            </div>
          </div>
          <div class="modal-footer">
            <div class="modal_actions">
              <ul>
                <li>
                  <a
                    href="javascript:void(0)"
                    class="gbtn gbtn_bdr"
                    data-dismiss="modal"
                    >Cancel</a
                  >
                </li>
                <li>
                  <button
                    class="btn gbtn"
                    id="extendDeliveryButton"
                    type="submit"
                  >
                    Extend Deadline
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--===== Markup For "Extend Delivery Modal" Ends Here =====-->

    <!--===== Markup For "" Starts From Here =====-->
    <!--===== Markup For "" Ends Here =====-->

    <!--jQuery Main Libraty Latest Version-->
    <script type="text/javascript" src="../../js/jquery-3.5.1.min.js"></script>
    <!--Bootstrap v4.5.3 JS File-->
    <script type="text/javascript" src="../../js/popper.min.js"></script>
    <script type="text/javascript" src="../../js/bootstrap.min.js"></script>
    <!--Lightcase JS File-->
    <script type="text/javascript" src="../../js/lightcase.js"></script>
    <!--Custom Script JS File-->
    <script type="text/javascript" src="../../js/updatedCustom.js"></script>
    
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"
      defer
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.31.0/js/vendor/jquery.ui.widget.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.31.0/js/jquery.iframe-transport.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.31.0/js/jquery.fileupload.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cloudinary-jquery-file-upload/2.11.4/cloudinary-jquery-file-upload.js"></script>
    <script
      src="https://upload-widget.cloudinary.com/global/all.js"
      type="text/javascript"
    ></script>

    <script>
      var currentUser = <%-JSON.stringify(currentUser)%>;
    </script>



    <script>
      (() => {
        $(document).ready(function () {
          var element = function (id) {
            return document.getElementById(id);
          };

          // Get Elements
          var textarea = element("textarea");

          $(document).ready(function () {
            $("#textarea").on("keyup", function (event) {
              maxLength = $("#textarea").val().length;
              $("#detailsMaxCounter").html(maxLength + "/2500");
            });
          });

          // Connect to socket.io
          var socket = io.connect();

          socket.on("connect_error", (err) => {
            console.log(`connect_error due to ${err.message}`);
          });

          socket.on("connect", () => {
            console.log(socket.connected); // true
          });

          socket.on("disconnect", () => {
            console.log(socket.connected); // false
          });

          if (socket !== undefined) {
            console.log("Connected to socket...");
            socket.emit("activity_room", jobId);

            socket.on("message", (data) => {
              console.log(data, " ACTIVITYU ROIOM EMIT");
              if (data) {
                if (data.messagesLength === "0") {
                  location.reload();
                }
                const parentDiv = document.createElement("div");
                parentDiv.setAttribute(
                  "class",
                  `updated_texts message${messagesLength}`
                );
                const childDiv = document.createElement("div");
                childDiv.setAttribute("class", "msg_wrap");
                const childSpan1 = document.createElement("span");
                childSpan1.setAttribute("class", "profile_link_image");
                const childAnchor = document.createElement("a");
                childAnchor.setAttribute("href", "javascript:void(0)");
                const childImage = document.createElement("img");
                var src, alt;
                if (job?.buyer?._id === data.user._id) {
                  src = job?.buyer?.profilePicture;
                  alt = job?.buyer?.firstName + " " + job?.buyer?.lastName;
                } else {
                  src = job?.seller?.profilePicture;
                  alt = job?.seller?.companyName;
                }
                childImage.setAttribute("src", src);
                childImage.setAttribute("alt", alt);
                childImage.setAttribute("class", "img-fluid");
                childImage.setAttribute("style", "max-width: 10%");
                childAnchor.append(childImage);
                childSpan1.append(childAnchor);
                childDiv.append(childSpan1);
                const childSpan2 = document.createElement("span");
                childSpan2.setAttribute("class", "msg_content");
                const childSpan3 = document.createElement("span");
                childSpan3.setAttribute("class", "msg_sender");
                childSpan3.innerHTML += alt;
                childSpan2.append(childSpan3);
                childSpan2.append(" | ");
                const childTime = document.createElement("time");
                childTime.innerHTML = data.createdAt;
                childSpan2.append(childTime);
                const childDiv2 = document.createElement("div");
                childDiv2.setAttribute("class", "msg_body");
                const childP = document.createElement("p");
                childP.innerHTML += data.message;
                childDiv2.append(childP);
                childSpan2.append(childDiv2);
                childDiv.append(childSpan2);
                parentDiv.append(childDiv);

                if (data.attachments.length > 0) {
                  const parentDiv = document.createElement("div");
                  data.attachments?.map((item, index) => {
                    const div = $(
                      `<div class="single_image">
                        <a
                        href=${item.url}
                        class="firstGallery"
                        data-rel="firstGallery:theSlider"
                        >
                        <img src=${item.url} class="img-fluid" alt="" />
                        </a>
                        </div>`
                    );
                    // parentDiv.append(div);
                    $(`.messages_images`).append(div);
                  });
                }
                messagesLength = parseInt(messagesLength) + 1;
              }
            });

            let fileURL = [];

            var myWidget = cloudinary.createUploadWidget(
              {
                cloudName: "gabazzo",
                uploadPreset: "message_attachments",
              },
              (error, result) => {
                if (!error && result && result.event === "success") {
                  console.log("Done! Here is the info: ", result.info);
                  fileURL.push({
                    url: result.info.secure_url,
                    type: result.info.format,
                  });
                  // $("#file_success").remove();
                  // $("#sending_options").append(
                  //   '<li id="file_success" style="color: green"><span>Files are attached successfully.</span><li>'
                  // );
                }
                if (error) {
                  console.log(error);
                }
                console.log(fileURL);
              }
            );

            document.getElementById("upload_widget").addEventListener(
              "click",
              function () {
                myWidget.open();
              },
              false
            );
            // Handle Input
            textarea.addEventListener("keydown", async function (event) {
              if (event.which === 13 && event.shiftKey == false) {
                if (textarea.value !== "") {
                  var url;
                  if (currentUser?.isCompany) {
                    url = "/company/send-message-activity";
                  } else {
                    url = "/user/send-message-activity";
                  }
                  $.ajax({
                    method: "POST",
                    url,
                    data: {
                      activity: jobId,
                      message: textarea.value,
                      attachments: fileURL,
                    },
                  }).done(function (data) {
                    console.log("data", data);
                    socket.emit("chatMessage", {
                      userId: currentUser._id,
                      room: jobId,
                      message: textarea.value.trim(),
                      attachments: fileURL,
                      messagesLength: messagesLength,
                    });
                    // Clear input
                    textarea.value = "";
                    textarea.focus();
                    fileURL = [];

                    event.preventDefault();
                  });
                }
              }
            });

            $("#sendMsgBtn").click(async function () {
              console.log("Asdasdasdasd")
              if (textarea.value !== "") {
                var url;
                if (currentUser?.isCompany) {
                  url = "/company/send-message-activity";
                } else {
                  url = "/user/send-message-activity";
                }
                $.ajax({
                  method: "POST",
                  url,
                  data: {
                    activity: jobId,
                    message: textarea.value,
                    attachments: fileURL,
                  },
                }).done(function (data) {
                  event.preventDefault();
                  console.log("data", data);
                  socket.emit("chatMessage", {
                    userId: currentUser._id,
                    room: jobId,
                    message: textarea.value.trim(),
                    attachments: fileURL,
                    messagesLength: messagesLength,
                  });
                  // Clear input
                  textarea.value = "";
                  textarea.focus();
                  fileURL = [];

                 
                });
              }
            });
          }
        });
      })();
    </script>

    <!--Custom JavaScript-->
    <script type="text/javascript">
      // Tracking System Navbar Links
      $(document).ready(function () {
        $(".dismiss_mobile_ts_menu").on("click", function () {
          $(".nav_with_bar .menu ul").removeClass("show");
        });

        $(".mobile_ts_menu_switch").on("click", function () {
          $(".nav_with_bar .menu ul").addClass("show");
        });

        $("a[name=completed]").on("click ", function () {
          if (progress === "100" && status === "Delivered") {
            // alert("yes");
            $.ajax({
              method: "POST",
              url: "/company/change-status",
              data: {
                job_id: jobId,
                status: "Awaiting Review",
              },
            }).done(function (data) {
              console.log("data", data);
              location.replace(`/review/${jobId}`);
            });
          }
        });

        $("button[id=extendDeliveryButton]").on("click ", function () {
          var extendDeliveryDays = $("#extendDeliveryDays")
            .find(":selected")
            .val();
          $.ajax({
            method: "POST",
            url: "/user/extend",
            data: {
              job_id: jobId,
              days: extendDeliveryDays,
            },
          }).done(function (data) {
            console.log("data", data);
            location.reload();
          });
        });
      });

      $(function () {
        $(".clickable-row").click(function () {
          window.location = $(this).data("href");
        });
      });

      // Code For Image Popup With Slider Starts
      $(document).ready(function () {
        var lightcase = $(".requirementsGallery");
        if (lightcase.length) {
          $("a[data-rel^=requirementsGallery]").lightcase({
            transition: "fadeInline",
            video: {
              width: 800,
              height: "auto",
              poster: "",
              preload: "auto",
              controls: true,
              autobuffer: true,
              autoplay: false,
              loop: false,
            },
            showSequenceInfo: false,
            showTitle: false,
          });
        }

        var lightcase = $(".firstGallery");
        if (lightcase.length) {
          $("a[data-rel^=firstGallery]").lightcase({
            transition: "fadeInline",
            video: {
              width: 800,
              height: "auto",
              poster: "",
              preload: "auto",
              controls: true,
              autobuffer: true,
              autoplay: false,
              loop: false,
            },
            showSequenceInfo: false,
            showTitle: false,
          });
        }

        var lightcase = $(".secondGallery");
        if (lightcase.length) {
          $("a[data-rel^=secondGallery]").lightcase({
            transition: "fadeInline",
            video: {
              width: 800,
              height: "auto",
              poster: "",
              preload: "auto",
              controls: true,
              autobuffer: true,
              autoplay: false,
              loop: false,
            },
            showSequenceInfo: false,
            showTitle: false,
          });
        }

        var lightcase = $(".thirdGallery");
        if (lightcase.length) {
          $("a[data-rel^=thirdGallery]").lightcase({
            transition: "fadeInline",
            video: {
              width: 800,
              height: "auto",
              poster: "",
              preload: "auto",
              controls: true,
              autobuffer: true,
              autoplay: false,
              loop: false,
            },
            showSequenceInfo: false,
            showTitle: false,
          });
        }

        var lightcase = $(".fourthGallery");
        if (lightcase.length) {
          $("a[data-rel^=fourthGallery]").lightcase({
            transition: "fadeInline",
            video: {
              width: 800,
              height: "auto",
              poster: "",
              preload: "auto",
              controls: true,
              autobuffer: true,
              autoplay: false,
              loop: false,
            },
            showSequenceInfo: false,
            showTitle: false,
          });
        }

        var lightcase = $(".fifthGallery");
        if (lightcase.length) {
          $("a[data-rel^=fifthGallery]").lightcase({
            transition: "fadeInline",
            video: {
              width: 800,
              height: "auto",
              poster: "",
              preload: "auto",
              controls: true,
              autobuffer: true,
              autoplay: false,
              loop: false,
            },
            showSequenceInfo: false,
            showTitle: false,
          });
        }

        var lightcase = $(".sixthGallery");
        if (lightcase.length) {
          $("a[data-rel^=sixthGallery]").lightcase({
            transition: "fadeInline",
            video: {
              width: 800,
              height: "auto",
              poster: "",
              preload: "auto",
              controls: true,
              autobuffer: true,
              autoplay: false,
              loop: false,
            },
            showSequenceInfo: false,
            showTitle: false,
          });
        }
      });
    </script>
  </body>
</html>
